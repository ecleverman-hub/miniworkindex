<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„ä¸ªäººå·¥ä½œå° Â· æ•ˆç‡ä¸å¥åº·ä¸­å¿ƒ</title>
 <!-- æ–°å¢ï¼šPWA ç›¸å…³ -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#3b82f6">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="icon-192.png" type="image/png">

    <!-- iOS æ”¯æŒï¼ˆå¯é€‰ä½†æ¨èï¼‰ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        /* å…¨å±€åŸºç¡€è®¾ç½® */
        :root {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            color-scheme: light dark;
            --color-primary: #3b82f6; /* è“è‰² */
            --color-secondary: #059669; /* ç»¿è‰² */
            --color-text: #333;
            --color-subtle: #4a5568;
            --color-background: #f7faff; /* ææµ…è“è‰²èƒŒæ™¯ */
            --color-card-bg: rgba(255, 255, 255, 0.98);
            --color-border: rgba(220, 230, 255, 0.8);
            --shadow-md: 0 10px 20px rgba(25, 55, 125, 0.1);
        }
        * {
            box-sizing: border-box;
            user-select: none; /* é»˜è®¤ç¦æ­¢é€‰æ‹©ï¼Œè®©å®ƒæ›´åƒä¸€ä¸ªåº”ç”¨ */
        }
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 30px; 
            background: var(--color-background);
        }
        
        /* App ä¸»å®¹å™¨ */
        .app {
            width: 100%;
            max-width: 1400px; /* è¿›ä¸€æ­¥æ‹“å®½ï¼Œé€‚åº”å››æ å¸ƒå±€ */
            background: var(--color-card-bg);
            border-radius: 24px;
            box-shadow: var(--shadow-md); 
            padding: 32px 36px 28px;
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        /* å¤´éƒ¨ï¼šæ ‡é¢˜ã€æ—¶é’Ÿ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--color-border);
        }
        .title-block h1 {
            font-size: 32px;
            margin: 0 0 4px;
            color: #1e3a8a;
            font-weight: 800;
        }
        .title-block p {
            margin: 0;
            font-size: 16px;
            opacity: 0.85;
            color: var(--color-subtle);
        }
        .pill {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 999px;
            background: #e0f2fe; 
            border: 1px solid #93c5fd;
            color: #1e40af;
            font-size: 13px;
            margin-right: 10px;
            white-space: nowrap;
            font-weight: 500;
            margin-top: 10px;
        }
        .clock-box {
            text-align: right;
            line-height: 1.2;
        }
        .clock {
            font-size: 48px;
            font-weight: 600;
            color: #1e3a8a;
            font-variant-numeric: tabular-nums;
        }
        .clock-sub {
            font-size: 16px;
            opacity: 0.9;
            color: var(--color-subtle);
        }

        /* æ ¸å¿ƒç½‘æ ¼å¸ƒå±€ï¼šå››åˆ—å¸ƒå±€ */
        .main-grid {
            display: grid;
            /* å››æ ï¼šTo-Do | çŠ¶æ€/ä¸“æ³¨ | ä¿¡æ¯/æ—¥å† | é•¿æœŸåŸåˆ™ */
            grid-template-columns: repeat(4, 1fr);
            gap: 24px; 
            margin-top: 15px;
        }

        /* å¡ç‰‡åŸºç¡€æ ·å¼ */
        .card {
            border-radius: 18px;
            border: 1px solid var(--color-border);
            padding: 24px; 
            background: linear-gradient(135deg, #ffffff, #fcfcff);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            transition: all 0.2s ease;
            min-height: 400px; /* ç»Ÿä¸€å¡ç‰‡é«˜åº¦ */
            display: flex;
            flex-direction: column;
        }
        .card h2 {
            font-size: 18px; 
            margin: 0 0 15px;
            color: #1e3a8a;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* 1. å¾…åŠäº‹é¡¹ (To-Do List) */
        #todo-input-wrap {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        #todo-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 15px;
            color: var(--color-text);
            font-family: inherit;
        }
        #todo-add-btn {
            padding: 10px 15px;
            background: var(--color-primary);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .todo-list-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            font-size: 15px;
            line-height: 1.5;
        }
        .todo-list-item input[type="checkbox"] {
            margin-top: 5px;
            margin-right: 10px;
            transform: scale(1.1);
            accent-color: var(--color-primary);
            cursor: pointer;
        }
        .todo-text {
            flex-grow: 1;
            user-select: text;
        }
        .todo-text.done {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .todo-remove {
            color: #ef4444;
            margin-left: 10px;
            cursor: pointer;
            opacity: 0.5;
        }

        /* 2. çŠ¶æ€å¡ç‰‡ & ä¸“æ³¨ */
        .status-label {
            font-size: 14px;
            margin: 10px 0 4px;
            color: var(--color-subtle);
            font-weight: 500;
        }
        .status-value {
            font-size: 26px; 
            font-weight: 700;
            line-height: 1.3;
        }
        .status-value.ok {
            color: var(--color-secondary); 
        }
        .status-value.rest {
            color: #f59e0b; 
        }
        .status-small {
            font-size: 13px;
            opacity: 0.85;
            margin-top: 6px;
            color: var(--color-subtle);
        }
        .focus-area {
            font-size: 14px;
            line-height: 1.7;
            white-space: pre-line;
            min-height: 80px;
            border: 1px dashed #93c5fd;
            padding: 10px;
            border-radius: 8px;
            color: var(--color-text);
            background-color: #f7f9ff;
            user-select: text;
        }
        .list {
            margin: 10px 0 0;
            padding-left: 20px;
            font-size: 14px;
            color: #555;
            line-height: 1.7;
        }
        .list li {
            margin-bottom: 5px;
        }
        
        /* 3. ä¿¡æ¯åŒºï¼šå¼•è¯­ä¸æ—¥å† */
        #quote-area {
            font-style: italic;
            font-size: 16px;
            line-height: 1.7;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 1px dashed var(--color-border);
            color: #555;
            min-height: 100px;
        }
        #quote-author {
            display: block;
            margin-top: 10px;
            font-size: 14px;
            text-align: right;
            color: var(--color-primary);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            font-size: 13px;
            text-align: center;
        }
        .day-header {
            font-weight: 600;
            color: var(--color-subtle);
        }
        .day-cell {
            padding: 6px 0;
            border-radius: 4px;
            background-color: #f0f4f9;
        }
        .day-cell.current {
            background-color: var(--color-primary);
            color: #fff;
            font-weight: 700;
        }

        /* 4. é•¿æœŸåŸåˆ™ */
        .lt-view {
            font-size: 15px;
            line-height: 1.8;
            white-space: pre-line;
            padding: 4px 0;
            color: var(--color-text);
            flex-grow: 1; /* æ’‘æ»¡å¡ç‰‡ç©ºé—´ */
            overflow-y: auto;
            user-select: text;
        }
        
        /* é€šç”¨ç¼–è¾‘åŒº */
        .lt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .tiny-btn {
            font-size: 12px;
            border-radius: 999px;
            padding: 6px 14px;
            border: 1px solid rgba(120,140,200,0.5);
            background: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.2s;
            color: var(--color-subtle);
        }
        .tiny-btn.primary {
            background: var(--color-primary);
            color: #fff;
            border-color: var(--color-primary);
        }
        .edit-area {
            margin-top: 10px;
        }
        .edit-textarea {
            width: 100%;
            min-height: 120px;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            border: 1px solid rgba(180,190,230,0.9);
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
            color: var(--color-text);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.03);
        }
        .edit-hint {
            font-size: 12px;
            opacity: 0.75;
            margin-top: 6px;
            color: #666;
        }
        .footer-tip {
            margin-top: 25px;
            font-size: 13px;
            opacity: 0.75;
            text-align: center;
            color: var(--color-subtle);
            padding-top: 15px;
            border-top: 1px solid var(--color-border);
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: repeat(2, 1fr); /* å››æ å˜ä¸¤æ  */
            }
            .card { min-height: auto; }
            #status-card { order: -1; } /* çŠ¶æ€å¡ç‰‡ä¼˜å…ˆæ˜¾ç¤º */
        }
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr; /* å•åˆ— */
                gap: 20px;
            }
            header {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 15px;
            }
            .clock-box {
                text-align: left;
                width: 100%;
                margin-top: 8px;
            }
            .clock { font-size: 32px; }
            .app { padding: 20px 20px 16px; }
        }
    </style>
</head>
<body>
<div class="app">
    <header>
        <div class="title-block">
            <h1>ğŸ§  ä¸ªäººå·¥ä½œå° Â· æ•ˆç‡ä¸å¥åº·ä¸­å¿ƒ</h1>
            <p>ä¸€åˆ‡ä»è¿™é‡Œå¼€å§‹ï¼šèšç„¦ä»Šæ—¥è¦äº‹ï¼Œå…³æ³¨èº«å¿ƒå¥åº·ï¼Œä¿æŒé•¿æœŸåŸåˆ™ã€‚</p>
            <div class="badge-row">
                <span class="pill">âœ… æ¯æ—¥å¾…åŠæ¸…å•</span>
                <span class="pill">ğŸŒŸ æŠ¤çœ¼è®¡æ—¶æé†’</span>
                <span class="pill">ğŸ“… å…³é”®ä¿¡æ¯èšåˆ</span>
            </div>
        </div>
        <div class="clock-box">
            <div class="clock" id="clock">--:--:--</div>
            <div class="clock-sub" id="clock-sub">åŠ è½½ä¸­â€¦</div>
        </div>
    </header>

    <div class="main-grid">
        
        <div class="card" id="todo-card">
            <h2>ğŸ“ æˆ‘çš„ä»Šæ—¥å¾…åŠæ¸…å•</h2>
            <div id="todo-input-wrap">
                <input type="text" id="todo-input" placeholder="è¾“å…¥æ–°çš„å¾…åŠäº‹é¡¹..." maxlength="80">
                <button id="todo-add-btn" class="tiny-btn primary">æ·»åŠ </button>
            </div>
            <div id="todo-list" style="overflow-y: auto; flex-grow: 1;">
                </div>
        </div>

        <div class="card" id="status-card">
            <h2>âœ¨ å¥åº·ä¸å·¥ä½œçŠ¶æ€</h2>
            
            <div class="status-label">å·¥ä½œæ¨¡å¼ï¼š</div>
            <div class="status-value" id="work-status">æ£€æµ‹ä¸­â€¦</div>
            <div class="status-small" id="next-rest">ä¸‹æ¬¡æŠ¤çœ¼æé†’ï¼š-- åˆ†é’Ÿå</div>

            <div class="lt-header" style="margin-top: 20px; border-top: 1px dashed var(--color-border); padding-top: 15px;">
                <h2>ğŸ¯ ä»Šæ—¥ä¸“æ³¨ï¼ˆM.I.T.ï¼‰</h2>
                <button id="focus-toggle-edit" class="tiny-btn">ç¼–è¾‘ç›®æ ‡</button>
            </div>
            <div id="focus-view" class="focus-area"></div>

            <div id="focus-edit-wrap" class="edit-area" style="display:none;">
                <textarea id="focus-editor" class="edit-textarea" placeholder="ä¸€è¡Œä¸€ä¸ªï¼Œåªå†™ 3 ä»¶ä»Šå¤©å¿…é¡»å®Œæˆçš„ M.I.T."></textarea>
                <div style="margin-top:8px; text-align:right;">
                    <button id="focus-save" class="tiny-btn primary">ä¿å­˜ç›®æ ‡</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“… ä¿¡æ¯èšåˆ</h2>
            <div id="quote-area">
                åŠ è½½æ¯æ—¥ä¸€å¥ä¸­...
                <span id="quote-author"></span>
            </div>
            
            <h2 style="margin-top: 0;">ğŸ—“ï¸ æœ¬æœˆæ—¥å†</h2>
            <div id="calendar-view" class="calendar-grid">
                </div>
        </div>

        <div class="card">
            <div class="lt-header">
                <h2>ğŸŒ¿ é•¿æœŸåŸåˆ™ä¸è‡ªæˆ‘å…³æ€€</h2>
                <button id="lt-toggle-edit" class="tiny-btn">ç¼–è¾‘åŸåˆ™</button>
            </div>

            <div id="lt-view" class="lt-view"></div>

            <div id="lt-edit-wrap" class="edit-area" style="display:none;">
                <textarea id="lt-editor" class="edit-textarea"></textarea>
                <div class="edit-hint">
                    ğŸ‘‰ å†™ä¸‹ä½ çš„é•¿æœŸç›®æ ‡ã€å·¥ä½œå“²å­¦ã€æˆ–ç»™è‡ªå·±çš„ç”Ÿæ´»åŸåˆ™ã€‚
                </div>
                <div style="margin-top:8px; text-align:right;">
                    <button id="lt-save" class="tiny-btn primary">ä¿å­˜åŸåˆ™</button>
                </div>
            </div>
        </div>
        
    </div>

    <div class="footer-tip">
        ğŸŒ± å»ºè®®ï¼šå°†æœ¬é¡µè®¾ç½®ä¸ºæµè§ˆå™¨é¦–é¡µï¼ˆæˆ–å›ºå®šæ ‡ç­¾é¡µï¼‰ï¼Œä¿æŒæ‰“å¼€ï¼Œè®©å®ƒæˆä¸ºæ‚¨çš„å¥åº·ä¸æ•ˆç‡â€œåå°â€ã€‚
    </div>
</div>

<script>
    // =============================
    // é…ç½®åŒº
    // =============================

    const REST_INTERVAL_MINUTES = 20;
    const WORK_PERIODS = [
        { start: "08:30", end: "12:00" },
        { start: "14:00", end: "18:00" }
    ];
    const DAILY_REMINDERS = {
        "09:30": "ä¸Šåˆçš„ç¬¬ä¸€æ¬¡ä¼‘æ¯ ğŸ‰\n\nâœ¦ **ä»ªå¼æ„ŸæŠ¤çœ¼ï¼š** è¿œçœº 5 åˆ†é’Ÿï¼Œé—­çœ¼æˆ–çƒ­æ•· 2 åˆ†é’Ÿï¼Œæ‹‰ä¼¸è‚©é¢ˆã€‚",
        "15:30": "ä¸‹åˆä¸­åœºåŠ æ²¹ç«™ ğŸ”‹\n\nâœ¦ **åˆåæŠ—ç–²åŠ³ï¼š** ç«™èµ·æ¥èµ°åŠ¨ 5 åˆ†é’Ÿï¼Œçœ‹è¿œå¤„ï¼Œæ…¢é€Ÿæ·±å‘¼å¸ 10 æ¬¡ã€‚",
    };
    
    // é»˜è®¤æ•°æ®
    const DEFAULT_LONG_TERM_TEXT = `â€¢ å¥åº·æ˜¯ç¬¬ä¸€ç”Ÿäº§åŠ›ï¼šå®æ„¿å°‘åšä¸€ç‚¹ï¼Œä¹Ÿè¦ç¡é¥±ã€åƒå¥½ã€‚
â€¢ ä¸“æ³¨äºä»·å€¼è€Œéå¿™ç¢Œï¼šæ¯å¤©åªåš 3 ä»¶æœ€é‡è¦çš„äº‹ï¼ˆM.I.T.ï¼‰ã€‚
â€¢ ä¿æŒå¥½å¥‡å¿ƒï¼šæ¯å¤©å­¦ä¸€ç‚¹æ–°ä¸œè¥¿ã€‚
â€¢ å‘¼å¸ä¸æ”¾æ¾ï¼šå·¥ä½œæ„Ÿåˆ°å‹åŠ›æ—¶ï¼Œæ·±å‘¼å¸ 6 æ¬¡ã€‚`;
    
    const DEFAULT_FOCUS_TEXT = `1. [åŒå‡»ç¼–è¾‘] ä»Šæ—¥ M.I.T. 1
2. [åŒå‡»ç¼–è¾‘] ä»Šæ—¥ M.I.T. 2
3. [åŒå‡»ç¼–è¾‘] ä»Šæ—¥ M.I.T. 3`;

    // æ¯æ—¥ä¸€è¨€ç¤ºä¾‹ï¼ˆå› æ— æ³•è°ƒç”¨å¤–éƒ¨APIï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®ï¼‰
    const DAILY_QUOTES = [
        { quote: "å¿ƒä¹‹æ‰€å‘ï¼Œç´ å±¥ä»¥å¾€ã€‚ç”Ÿå¦‚é€†æ—…ï¼Œä¸€è‹‡ä»¥èˆªã€‚", author: "ä¸ƒå ‡å¹´" },
        { quote: "æŠŠæ—¶é—´èŠ±åœ¨ä½ æœ€é‡è§†çš„äº‹æƒ…ä¸Šï¼Œè¿™æ‰æ˜¯çœŸæ­£çš„æ•ˆç‡ã€‚", author: "å²è’‚èŠ¬Â·æŸ¯ç»´" },
        { quote: "æˆ‘ä»¬æœ€å¤§çš„å¼±ç‚¹åœ¨äºæ”¾å¼ƒã€‚æˆåŠŸçš„å¿…ç»ä¹‹è·¯å°±æ˜¯ä¸æ–­åœ°é‡æ¥ä¸€æ¬¡ã€‚", author: "æ‰˜é©¬æ–¯Â·çˆ±è¿ªç”Ÿ" },
        { quote: "ç”Ÿæ´»çš„è¦è¯€ï¼Œæ˜¯åŸè°…è‡ªå·±ï¼Œæ¥å—è‡ªå·±ï¼Œç„¶åçˆ±è‡ªå·±ã€‚", author: "ä½šå" },
        { quote: "ä¸“æ³¨å½“ä¸‹ï¼Œæ‰æ˜¯å¯¹æŠ—ç„¦è™‘çš„æœ€å¥½æ–¹å¼ã€‚", author: "å²è’‚å¤«Â·ä¹”å¸ƒæ–¯" },
        { quote: "å¥åº·æ˜¯äººç”Ÿç¬¬ä¸€è´¢å¯Œã€‚", author: "çˆ±é»˜ç”Ÿ" }
    ];
    
    // Local Storage Keys V4
    const LONG_TERM_KEY = "health_hub_long_term_notes_v4";
    const FOCUS_KEY = "health_hub_focus_today_v4";
    const TODO_KEY = "health_hub_todo_list_v4";

    // =============================
    // å·¥å…·å‡½æ•° (ä¿æŒä¸å˜)
    // =============================
    function parseTimeToMinutes(hhmm) {
        const [h, m] = hhmm.split(":").map(Number);
        return h * 60 + m;
    }
    function getMinutesFromMidnight(date) {
        return date.getHours() * 60 + date.getMinutes();
    }
    function inWorkTime(now) {
        const minutes = getMinutesFromMidnight(now);
        return WORK_PERIODS.some(p => {
            const start = parseTimeToMinutes(p.start);
            const end = parseTimeToMinutes(p.end);
            return minutes >= start && minutes <= end;
        });
    }
    function updateClock(now) {
        // ... (æ—¶é’Ÿæ›´æ–°é€»è¾‘) ...
        const clockEl = document.getElementById("clock");
        const subEl = document.getElementById("clock-sub");
        const hh = String(now.getHours()).padStart(2, "0");
        const mm = String(now.getMinutes()).padStart(2, "0");
        const ss = String(now.getSeconds()).padStart(2, "0");
        clockEl.textContent = `${hh}:${mm}:${ss}`;
        const weekdayNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        const y = now.getFullYear();
        const mon = now.getMonth() + 1;
        const d = now.getDate();
        const wd = weekdayNames[now.getDay()];
        subEl.textContent = `${y} å¹´ ${mon} æœˆ ${d} æ—¥ Â· æ˜ŸæœŸ${wd}`;
    }
    function updateWorkStatus(isWorking, remainingMinutes) {
        // ... (çŠ¶æ€æ›´æ–°é€»è¾‘) ...
        const statusEl = document.getElementById("work-status");
        const nextRestEl = document.getElementById("next-rest");
        if (isWorking) {
            statusEl.textContent = "ä¸“æ³¨å·¥ä½œæ¨¡å¼ (æé†’å·²å¯ç”¨)";
            statusEl.classList.remove("rest");
            statusEl.classList.add("ok");
            if (remainingMinutes != null) {
                nextRestEl.textContent = `ä¸‹æ¬¡ 20-20-20 ä¼‘æ¯ï¼šçº¦ ${remainingMinutes} åˆ†é’Ÿå`;
            } else {
                nextRestEl.textContent = "ä¸‹æ¬¡ä¼‘æ¯æ—¶é—´è®¡ç®—ä¸­â€¦";
            }
        } else {
            statusEl.textContent = "éå·¥ä½œæ—¶é—´ (æé†’å·²æš‚åœ)";
            statusEl.classList.remove("ok");
            statusEl.classList.add("rest");
            nextRestEl.textContent = `å½“å‰ä¸åœ¨è®¾å®šå·¥ä½œæ—¶æ®µï¼ˆ${WORK_PERIODS.map(p => `${p.start}â€“${p.end}`).join(' / ')}ï¼‰ï¼Œä¼‘æ¯ä¸€ä¸‹å§ï¼`;
        }
    }

    // =============================
    // æ¯æ—¥ä¸€è¨€ (Quote)
    // =============================
    function initDailyQuote() {
        const todayIndex = new Date().getDate() % DAILY_QUOTES.length;
        const quoteObj = DAILY_QUOTES[todayIndex];
        
        const quoteEl = document.getElementById("quote-area");
        const authorEl = document.getElementById("quote-author");

        quoteEl.textContent = "â€œ " + quoteObj.quote + " â€";
        authorEl.textContent = "â€”â€” " + quoteObj.author;
    }

    // =============================
    // ç®€å•æ—¥å† (Calendar)
    // =============================
    function initSimpleCalendar() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth(); 
        const todayDate = now.getDate();
        const calendarEl = document.getElementById("calendar-view");
        
        // 1. è·å–æœ¬æœˆç¬¬ä¸€å¤©æ˜¯å‘¨å‡  (0=å‘¨æ—¥, 1=å‘¨ä¸€...)
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        // 2. è·å–æœ¬æœˆæ€»å¤©æ•°
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        const dayNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        let html = dayNames.map(d => `<div class="day-header">${d}</div>`).join('');

        // å¡«å……æœˆä»½å‰çš„ç©ºç™½ï¼ˆä¸Šä¸ªæœˆçš„æ—¥æœŸï¼‰
        // getDay() è¿”å› 0-6ã€‚å¦‚æœç¬¬ä¸€å¤©æ˜¯å‘¨ä¸€(1)ï¼Œåˆ™å¡«å…… 1 ä¸ªç©ºç™½ï¼›å‘¨æ—¥(0)åˆ™å¡«å…… 0 ä¸ª
        const startDay = firstDayOfMonth === 0 ? 0 : firstDayOfMonth; // ä»å‘¨æ—¥å¼€å§‹æ’ï¼Œå‘¨æ—¥æ˜¯0
        for (let i = 0; i < startDay; i++) {
            html += `<div class="day-cell" style="background: none;"></div>`;
        }
        
        // å¡«å……æœ¬æœˆæ—¥æœŸ
        for (let d = 1; d <= daysInMonth; d++) {
            const isToday = (d === todayDate) ? 'current' : '';
            html += `<div class="day-cell ${isToday}">${d}</div>`;
        }

        calendarEl.innerHTML = html;
    }

    // =============================
    // é•¿æœŸåŸåˆ™ & ä»Šæ—¥ä¸“æ³¨ (é€šç”¨åŠ è½½/ä¿å­˜é€»è¾‘)
    // =============================
    function setupTextEditor(viewId, editorId, toggleBtnId, saveBtnId, editWrapId, key, defaultText) {
        const view = document.getElementById(viewId);
        const editor = document.getElementById(editorId);
        const toggleBtn = document.getElementById(toggleBtnId);
        const editWrap = document.getElementById(editWrapId);

        function loadText() {
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return null;
                if (key === FOCUS_KEY) {
                    const parsed = JSON.parse(raw);
                    const todayStr = new Date().toISOString().slice(0, 10);
                    if (parsed && parsed.date === todayStr) {
                        return parsed.text;
                    } else {
                        return null; // æ—¥æœŸä¸åŒ¹é…ï¼Œé‡ç½®
                    }
                }
                return String(raw);
            } catch (e) {
                return null;
            }
        }

        function saveText(text) {
            try {
                if (key === FOCUS_KEY) {
                    const todayStr = new Date().toISOString().slice(0, 10);
                    localStorage.setItem(key, JSON.stringify({ date: todayStr, text: text || "" }));
                } else {
                    localStorage.setItem(key, text || "");
                }
            } catch (e) { /* ignore */ }
        }

        let saved = loadText();
        let currentText = saved == null ? defaultText : saved;

        view.textContent = currentText;
        editor.value = currentText;

        let editing = false;

        toggleBtn.addEventListener("click", () => {
            editing = !editing;
            if (editing) {
                editWrap.style.display = "block";
                toggleBtn.textContent = "æ”¶èµ·ç¼–è¾‘";
            } else {
                const currentTextInEditor = editor.value.trim();
                if (currentTextInEditor !== view.textContent.trim()) {
                    saveText(currentTextInEditor);
                    view.textContent = currentTextInEditor || defaultText;
                }
                editWrap.style.display = "none";
                toggleBtn.textContent = (key === LONG_TERM_KEY) ? "ç¼–è¾‘åŸåˆ™" : "ç¼–è¾‘ç›®æ ‡";
            }
        });
        
        if (key === FOCUS_KEY) {
            view.addEventListener("dblclick", () => {
                if (!editing) { toggleBtn.click(); }
            });
        }

        document.getElementById(saveBtnId).addEventListener("click", () => {
            const txt = editor.value.trim();
            saveText(txt);
            view.textContent = txt || defaultText;
            editing = false;
            editWrap.style.display = "none";
            toggleBtn.textContent = (key === LONG_TERM_KEY) ? "ç¼–è¾‘åŸåˆ™" : "ç¼–è¾‘ç›®æ ‡";
        });
    }

    function initLongTerm() {
        setupTextEditor("lt-view", "lt-editor", "lt-toggle-edit", "lt-save", "lt-edit-wrap", LONG_TERM_KEY, DEFAULT_LONG_TERM_TEXT);
    }
    
    function initFocusToday() {
        setupTextEditor("focus-view", "focus-editor", "focus-toggle-edit", "focus-save", "focus-edit-wrap", FOCUS_KEY, DEFAULT_FOCUS_TEXT);
    }
    
    // =============================
    // å¾…åŠäº‹é¡¹ (To-Do List)
    // =============================
    function loadTodos() {
        try {
            const raw = localStorage.getItem(TODO_KEY);
            return raw ? JSON.parse(raw) : [];
        } catch (e) {
            return [];
        }
    }

    function saveTodos(todos) {
        try {
            localStorage.setItem(TODO_KEY, JSON.stringify(todos));
        } catch (e) { /* ignore */ }
    }

    function renderTodos() {
        const listEl = document.getElementById('todo-list');
        const todos = loadTodos();
        listEl.innerHTML = '';

        if (todos.length === 0) {
            listEl.innerHTML = '<div style="opacity: 0.6; text-align: center; padding: 30px 0;">ğŸ‘ æ²¡æœ‰æœªå®Œæˆäº‹é¡¹ï¼ŒçœŸæ£’ï¼</div>';
            return;
        }

        todos.forEach((todo, index) => {
            const item = document.createElement('div');
            item.className = 'todo-list-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = todo.done;
            checkbox.addEventListener('change', () => {
                todos[index].done = checkbox.checked;
                saveTodos(todos);
                renderTodos();
            });

            const textSpan = document.createElement('span');
            textSpan.className = todo.done ? 'todo-text done' : 'todo-text';
            textSpan.textContent = todo.text;

            const removeBtn = document.createElement('span');
            removeBtn.className = 'todo-remove';
            removeBtn.innerHTML = '&#10005;'; // X mark
            removeBtn.title = 'åˆ é™¤æ­¤é¡¹';
            removeBtn.addEventListener('click', () => {
                // ä»…åˆ é™¤æœªå®Œæˆçš„ä»»åŠ¡ï¼Œæˆ–åŒæ—¶åˆ é™¤å·²å®Œæˆçš„ä»»åŠ¡
                todos.splice(index, 1);
                saveTodos(todos);
                renderTodos();
            });

            item.appendChild(checkbox);
            item.appendChild(textSpan);
            item.appendChild(removeBtn);
            listEl.appendChild(item);
        });
    }

    function initTodoList() {
        const inputEl = document.getElementById('todo-input');
        const addBtn = document.getElementById('todo-add-btn');

        const addTodo = () => {
            const text = inputEl.value.trim();
            if (text) {
                const todos = loadTodos();
                todos.unshift({ text: text, done: false }); // æ–°ä»»åŠ¡æ”¾åœ¨æœ€å‰é¢
                saveTodos(todos);
                inputEl.value = '';
                renderTodos();
            }
        };

        addBtn.addEventListener('click', addTodo);
        inputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        renderTodos();
    }

    // =============================
    // ä¸»å¾ªç¯ï¼šæŠ¤çœ¼æé†’
    // =============================

    (function () {
        let lastRestTimestamp = Date.now();
        let remindedToday = {}; 
        let lastMinuteStr = "";

        function loop() {
            const now = new Date();
            const todayStr = now.toISOString().slice(0, 10);
            const hh = String(now.getHours()).padStart(2, "0");
            const mm = String(now.getMinutes()).padStart(2, "0");
            const currentTimeStr = `${hh}:${mm}`;

            updateClock(now);

            const working = inWorkTime(now);
            const intervalMs = REST_INTERVAL_MINUTES * 60 * 1000;
            let remainingMinutes = null;

            if (!working) {
                lastRestTimestamp = Date.now();
                updateWorkStatus(false, null);
                setTimeout(loop, 1000);
                return;
            }

            const elapsed = Date.now() - lastRestTimestamp;
            const toNext = Math.max(0, intervalMs - elapsed);
            remainingMinutes = Math.max(0, Math.ceil(toNext / 60000));
            updateWorkStatus(true, remainingMinutes);

            // 1ï¼‰20 åˆ†é’ŸæŠ¤çœ¼æé†’
            if (elapsed >= intervalMs) {
                alert(
                    "ğŸ‘€ 20-20-20 å¼ºåˆ¶ä¼‘æ¯æé†’ï¼\n\n" +
                    `ä½ å·²ä¸“æ³¨å·¥ä½œçº¦ ${REST_INTERVAL_MINUTES} åˆ†é’Ÿï¼è¯·èµ·èº«/è½¬å¤´ä¼‘æ¯ã€‚\n\n` +
                    "è¯·ç«‹å³ï¼š\n" +
                    "1. çœ‹ 6 ç±³ä¹‹å¤–çš„è¿œå¤„è‡³å°‘ 20 ç§’\n" +
                    "2. åˆ»æ„å¤šçœ¨çœ¼ï¼Œè½¬åŠ¨çœ¼çƒ\n" +
                    "3. æ´»åŠ¨è„–å­å’Œè‚©è†€\n\n" +
                    "ç‚¹å‡»â€œç¡®è®¤â€åï¼Œè®¡æ—¶å°†é‡æ–°å¼€å§‹ã€‚"
                );
                lastRestTimestamp = Date.now();
            }

            // 2ï¼‰å›ºå®šæ—¶é—´æŠ¤çœ¼æé†’
            if (currentTimeStr !== lastMinuteStr) {
                lastMinuteStr = currentTimeStr;

                for (const key in remindedToday) {
                    if (remindedToday[key] !== todayStr) {
                        delete remindedToday[key];
                    }
                }

                if (DAILY_REMINDERS[currentTimeStr]) {
                    const lastDate = remindedToday[currentTimeStr];
                    if (lastDate !== todayStr) {
                        alert("ğŸ”” å¥åº·ä¸­å¿ƒæé†’ï¼š\n\n" + DAILY_REMINDERS[currentTimeStr]);
                        remindedToday[currentTimeStr] = todayStr;
                    }
                }
            }

            setTimeout(loop, 1000);
        }

        window.addEventListener("load", function () {
            // åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
            initDailyQuote();
            initSimpleCalendar();
            initLongTerm();
            initFocusToday();
            initTodoList();
            
            // é¦–æ¬¡å¯åŠ¨å¼¹çª—
            alert(
                "ğŸ‰ å·¥ä½œå° V4 å·²å¯åŠ¨ï¼\n\n" +
                "æœ¬æ¬¡é›†æˆäº†ï¼š\n" +
                "â€¢ å¾…åŠæ¸…å•ï¼šå¯æ·»åŠ ã€å®Œæˆå’Œåˆ é™¤ã€‚\n" +
                "â€¢ æ—¥å†/å¼•è¯­ï¼šæä¾›å…³é”®ä¿¡æ¯å’Œæ¿€åŠ±ã€‚\n" +
                "â€¢ æŠ¤çœ¼åŠŸèƒ½ï¼š20åˆ†é’Ÿå¼ºåˆ¶ä¼‘æ¯æé†’ã€‚\n\n" +
                "æ•°æ®ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œè¯·ä¿æŒä½¿ç”¨ï¼ŒæŒç»­å…³æ³¨æ•ˆç‡ä¸å¥åº·ï¼"
            );
            loop();
        });
    })();
  // æ³¨å†Œ Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function () {
      navigator.serviceWorker.register('./service-worker.js')
        .then(function (reg) {
          console.log('Service Worker æ³¨å†ŒæˆåŠŸ', reg);
        })
        .catch(function (err) {
          console.log('Service Worker æ³¨å†Œå¤±è´¥', err);
        });
    });
  }
</script>
</body>
</html>
